<div class="boxed-page">
<div class="container clearfix">
<section id="camera-single" >

<!--sidebar start-->
<div id="sidebar" class="nav-collapse col-md-2 col-xs-12">
<ul class="sidebar-menu" id="nav-accordion">
  <li class="sub-menu">
    <a href="/">
      <span class="glyphicon glyphicon-camera"></span>
      <span>  My Cameras</span>
    </a>
  </li>
  <li>
    <ul class="sub">
      <li><a href="">Mast Wicklow</a></li>
      <li><a href="/single-camera.html">Remembrance Cam</a></li>
      <li><a href="">Rooftop Cam</a></li>
      <li><a href="">Reykjavik Harbour</a></li>
      <li><a href="">Washington Uni</a></li>
    </ul>
  </li>
  <li>
    <a href="/cameras/new" class="active"><span class="glyphicon glyphicon-plus"></span>
      <span>  Add A Camera</span></a>
  </li>
</ul>
</div>
<!--sidebar end-->


<!--main content start-->
<div class="col-lg-10 col-xs-12 wrapper">
<section id="main-content">


<h3>Add A Camera</h3>

<form action="#" method="post">
<%= hidden_field_tag :authenticity_token, form_authenticity_token -%>

<!-- STEP 1 -->
<fieldset>
    <div class='row add-row'>
        <div class='col-lg-3'>
            <span class="label label-primary">1</span><h5>Evercam Camera Info</h5>
        </div>
        <div class='col-lg-3 form-group'>
            <label class="control-label" for="camera-name">Camera Name</label>
            <span data-toggle="tooltip" data-title="This is the friendly name you will give to your Camera to identify it in the Evercam Dashboard" class="label label-default">more info</span>
            <input id="camera-name" name="camera-name" placeholder="Rooftop Camera" class="form-control input-sm" required="" type="text" data-validation="alphanumeric" data-validation-allowing="-_ " data-validation-error-msg="Can contain letters, numbers, spaces and hyphens." value="<%= params['camera-name'] %>">
        </div>
        <div class='col-lg-3 form-group'>
            <label class="control-label" for="camera-id">Camera ID</label>
            <span data-toggle="tooltip" data-title="This the ID you have to create for your Camera that will need to be Unique for Evercam." class="label label-default">more info</span>
            <input id="camera-id" name="camera-id" placeholder="roof-cam" class="form-control input-sm" required="" type="text" data-validation="alphanumeric" data-validation-allowing="-_" data-validation-error-msg="The ID needs to be unique and contain letters and '-'. No spaces." value="<%= params['camera-id'] %>">
        </div>
    </div>

</fieldset>

<!-- STEP 2 -->
<fieldset>
    <div class='row add-row'>
        <div class='col-lg-3'>
            <span class="label label-primary">2</span><h5>Cameras Credentials</h5>
        </div>
        <div class='col-lg-3 form-group'>
            <label class="control-label" for="camera-username">Camera Username</label>
            <span data-toggle="tooltip" data-title="The camera you are trying to connect will already have a Username that you will need to enter here. It will have been created by the camera owner" class="label label-default">more info</span>
            <input id="camera-username" name="camera-username" placeholder="" class="form-control input-sm" type="text" value="<%= params['camera-username'] %>">
        </div>
        <div class='col-lg-3 form-group'>
            <label class="control-label" for="camera-password">Camera Password</label>
            <span data-toggle="tooltip" data-title="The camera you are trying to connect will already have a Password that will have been created by the camera owner" class="label label-default">more info</span>
            <input id="camera-password" name="camera-password" placeholder="" class="form-control input-sm" type="text" value="<%= params['camera-password'] %>">
        </div>
    </div>
</fieldset>

<!-- STEP 3 -->
<fieldset>
<div class='row add-row'>
    <div class='col-lg-3'>
        <span class="label label-primary">3</span><h5>Path to your Camera</h5>
    </div>
    <div class='col-lg-5'>
        <div class='row'>
            <div class='col-lg-8 form-group'>
                    <label class="control-label" for="camera-url">External IP (or URL)</label>
                    <span data-toggle="tooltip" data-title="This will just contain the IP address in the form of 149.237.192.68 - http:// is already included" class="label label-default">more info</span>
                <div class="input-group">
                    <span class="input-group-addon">http://</span>
                    <input id="camera-url" name="camera-url" placeholder="149.237.192.68" class="form-control input-sm" required="" type="text" data-validation="custom" data-validation-regexp="^(\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b)$" data-validation-error-msg="This doesn't appear to be a valid IP." value="<%= params['camera-url'] %>">
                </div>
            </div>
        </div>
        <div class='row'>
            <div class='col-lg-6 form-group'>
                <label class="control-label" for="port">Ext. HTTP Port</label>
                <!--<span data-toggle="tooltip" data-title="The snapshot URL is the path to where the cameras snapshots are currently stored." class="label label-default">more info</span>-->
                <input id="port" name="port" placeholder="8901" class="form-control input-sm" required="" type="text" data-validation="custom" data-validation-regexp="^[0-9]{2,5}$"  data-validation-error-msg="The Port should be a 2-5 digit number." value="<%= params['port'] %>">
            </div>
            <div class='col-lg-6 form-group'>
               <label class="control-label" for="port">Ext. RTSP Port</label>
               <span data-toggle="tooltip" data-title="This Field is optional." class="label label-default">optional</span>
                <input id="port" name="rtsp-port" placeholder="8901" class="form-control input-sm" required="" type="text" data-validation="custom" data-validation-regexp="^[0-9]{2,5}$"  data-validation-error-msg="The Port should be a 2-5 digit number." value="<%= params['ext-rtsp-port'] %>">
            </div>
        </div>
        <div class='row'>
            <div class='col-lg-12 form-group'>
                <label class="control-label" for="snapshot">Snapshot URL</label>
                <span data-toggle="tooltip" data-title="The snapshot URL is the path to where the cameras snapshots are currently stored. It must begin with '/'" class="label label-default">more info</span>
                <input type="text" id="snapshot" name="snapshot" placeholder="/snapshot.jpg" class="form-control input-sm" data-validation="custom" data-validation-regexp="^/[a-zA-Z0-9._/-]{2,100}$" data-validation-error-msg="This doesn't appear to be a valid URL" value="<%= params['snapshot'] %>" >
            </div>
          <p class="text-center"><a href="#" id="test" class="btn btn-primary ladda-button" role="button" data-style="expand-left"><span class="ladda-label">Test Snapshot</span></a></p>
        </div>
        <div class="alert">
          <a href="#" class="close" data-dismiss="alert">&times;</a>
            <span id="test-error"><%= flash[:message] %></span>
        </div>
    </div>
    <div class='col-lg-3'>
        <div class="media">
            <img id="testimg" src="/" class="text-center" width="100%">
        </div>
            <p class="text-center"><span data-toggle="tooltip" data-placement="top" data-title="If you have entered the correct Credentials, Camera URL/IP and Port into the fields to the left, the image above should show you what your camera is seeing right now. If there is no preview, then some of the information you have entered could be incorrect. Please check the info or refer to your Camera's Manual." class="label label-default">more info</span></p>
    </div>
</div>
</fieldset>

<div class="row add-row">
<div id="additional">
  <div class='col-lg-3'>
    <span class="label label-primary">4</span><h5><span class="glyphicon glyphicon-plus"></span> Additional Settings</h5>
  </div>
</div>

<div id="settings">
<!-- STEP 4 -->
<div class='col-lg-5'>
    <div class='row'>
        <div class='col-lg-6 form-group'>
            <label class="control-label" for="camera-vendor">Camera Vendor</label>
            <!--<span data-toggle="tooltip" data-title="" class="label label-default">more info</span>-->
            <select id="camera-vendor" name="camera-vendor" class="form-control input-sm">
            <option value="-1">Select Make</option>
              <% @vendors.each_with_index  do |v, index| -%>
              <option value="<%= v.exid -%>">
                <%= v.name -%>
              </option>
              <% end %>
            </select>
        </div>

        <div class='col-lg-6 form-group'>
            <label class="control-label">Camera Model</label>
            <!--<span data-toggle="tooltip" data-title="" class="label label-default">more info</span>-->
          <% @vendors.each do |v| -%>
          <select id="camera-model<%= v.exid -%>" name="camera-model" class="form-control input-sm hidden">
            <% v.vendor_models.each_with_index  do |m, index| -%>
              <% if index == 0 %>
                <option selected="selected" value="<%= m.name  -%>"><%= m.name -%></option>
                <% else %>
                <option value="<%= m.name  -%>"><%= m.name -%></option>
              <% end %>
            <% end -%>
          </select>
          <% end %>
        </div>
    </div>
    <div class="row">
        <div class='col-lg-8 form-group'>
            <label class="control-label" for="local-ip">Local IP</label>
            <!--<span data-toggle="tooltip" data-title="" class="label label-default">more info</span>-->
            <input id="local-ip" name="local-ip" placeholder="" class="form-control input-sm" type="text" data-validation="custom" data-validation-regexp="^[0-9]{2,4}$"  data-validation-error-msg="The Port should be a 2-4 digit number." data-validation-optional="true" value="<%= params['http-port'] %>">
        </div>
    </div>
    <div class="row">
        <div class='col-lg-6 form-group'>
        <label class="control-label" for="local-http">Local HTTP Port</label>
        <!--<span data-toggle="tooltip" data-title="" class="label label-default">more info</span>-->
        <input id="local-http" name="local-http" placeholder="" class="form-control input-sm" type="text" data-validation="custom" data-validation-regexp="^[0-9]{2,5}$"  data-validation-error-msg="The Port should be a 2-5 digit number." data-validation-optional="true" value="<%= params['rtsp-port'] %>">
        </div>
        <div class='col-lg-6 form-group'>
        <label class="control-label" for="local-rtsp">Local RTSP Port</label>
        <!--<span data-toggle="tooltip" data-title="" class="label label-default">more info</span>-->
        <input id="local-rtsp" name="local-rtsp" placeholder="" class="form-control input-sm" type="text" data-validation="custom" data-validation-regexp="^[0-9]{2,5}$"  data-validation-error-msg="The Port should be a 2-5 digit number." data-validation-optional="true" value="<%= params['rtsp-port'] %>">
        </div>
    </div>
    <div class='row'>
      <div class="text-center finish">
        <!-- Button -->
        <div class='col-lg-12'>
          <div class="form-group">
            <label class="control-label" for="add-button"></label>
            <button id="add-button" name="add-button" class="btn btn-primary">Finish &amp; Add</button>
          </div>
        </div>
      </div>
    </div>
</div>
</div><!-- End Settings -->
</div>

<!-- FINISH & ADD -->



<!-- SUPPORT -->
<div class="row add-row add-footer">
  <div class='col-lg-5 col-lg-offset-3'>
    <h5>Still Can't See Your Camera?</h5>
    <ul class="list-inline">
      <li><a href="#">FAQ/common-connection-issues</a></li>
      <li><a href="#">Get our Support Team to connect your Camera</a></li>
    </ul>
  </div>
</div>

</form>

</section>
<!--main content end-->
</div>
</section>
</div>
</div> <!--boxed page end-->

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-form-validator/2.1.47/jquery.form-validator.min.js"></script>
<script>
  $(function () {
    $('body').popover({
      selector: '[data-toggle="popover"]'
    });

    $('body').tooltip({
      selector: 'a[rel="tooltip"], [data-toggle="tooltip"]'
    });

    $('#test').click(function(e) {
      var params = ['external_url=http://' + $('#camera-url').val() + ':' + $('#port').val(), 'jpg_url=' + $('#snapshot').val(),
        'cam_username=' + $('#camera-username').val(), 'cam_password=' + $('#camera-password').val()];
      e.preventDefault();
      var l = Ladda.create(this);
      l.start();
      var progress = 0;
      var interval = setInterval( function() {
        progress = Math.min( progress + 0.025, 1 );
        l.setProgress( progress );

        if( progress === 1 ) {
          l.stop();
          clearInterval( interval );
        }
      }, 200 );
      $.getJSON('https://dashboard.evercam.io/v1/cameras/test.json?' + params.join('&'))
        .done(function(resp) {
          console.log('success');
          $('#testimg').attr('src', resp.data);
        })
        .fail(function(resp) {
          $('#test-error').text(resp.responseJSON.message);
          console.log('error');
        })
        .always(function() {
          l.stop();
          clearInterval( interval );
        });

        $( "#additional" ).click(function() {
            $( "#settings" ).slideToggle( "slow", function() {
              });
            });

    var previous;
    $('#camera-vendor').one('focus', function() {
      previous = this.value;
    }).on('change', function() {
      $('#camera-model' + previous).addClass('hidden');
      $('#camera-model' + this.value).removeClass('hidden');
      previous = this.value;
    });

  });

  $.validate();


</script>
