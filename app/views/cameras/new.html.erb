<div class="bb-alert alert alert-info" style="display:none;">
  <span></span>
</div>
<div class="boxed-page">
<div class="container clearfix">
<section id="camera-single" >
<!--sidebar start-->
<div id="sidebar" class="col-lg-2 col-xs-12">
  <ul class="sidebar-menu">
    <li class="menu-item">
      <a href="/cameras">
        <span>My Cameras</span>
      </a>
    </li>

    <li class="menu-item">
      <a href="/cameras">
        <span>Cameras Shared With Me</span>
      </a>
    </li>

    <li class="menu-item active">
      <a href="/cameras/new"><span class="glyphicon glyphicon-plus"></span>Add IP Camera</a>
    </li>
    <li class="menu-item">
      <a href="/add-android"><span class="glyphicon glyphicon-plus"></span>Add Android Camera</a>
    </li>
    <li class="menu-item">
      <a href="/publiccam">Public Cameras</a>
    </li>
  </ul>
</div>
<!--sidebar end-->
<!--main content start-->
<div class="col-lg-10 col-xs-12 wrapper">
  <section id="main-content">
    <div class="row add-ip-header">
      <div class='col-md-12'>
        <h3>Add an IP Camera</h3>
        <p>Connect an IP Camera to Evercam</p>
      </div>
    </div>

<!-- FORM START -->
<%= form_tag('/cameras/new', method: 'post', class: "has-validation-callback") do %>
<% field_errors = (flash[:field_errors] || {}) %>

<!-- STEP 1 -->
<fieldset>
  <div class='row add-row'>
    <div class='col-md-8'>
      <div class='col-md-5 form-group<%= field_errors["name"] ? ' has-error' : '' %>'>
        <%= label_tag('camera-name', "Friendly Name*", class: "control-label") %>
        <%= text_field_tag("camera-name", @user['camera-name'], "placeholder" => "Rooftop Camera", "class" => "form-control", "data-validation" => "alphanumeric length", "data-validation-length" => "max24", "data-validation-allowing" => "-_ ", "data-validation-error-msg" => "Max 24 characters containing letters, spaces and hyphens.") %>
      <% if field_errors["name"] %>
        <span class="help-block form-error text-left"><%= field_errors["name"] %></span>
      <% end %>
      </div>
      <div class='col-md-5 model form-group<%= field_errors["id"] ? ' has-error' : '' %>'>
        <%= label_tag('camera-id', "Evercam ID*", class: "control-label") %>
        <%= text_field_tag("camera-id", @user['camera-id'], "placeholder" => "roof-cam", "class" => "form-control", "data-validation" => "alphanumeric length custom", "data-validation-regexp" => "^[a-z0-9._/-]{2,100}$", "data-validation-length" => "min4", "data-validation-allowing" => "-_", "data-validation-error-msg" => "Min 4 characters. Only lowercase letters, numbers &amp; hyphens and underscores. No spaces.") %>
      <% if field_errors["id"] %>
        <span class="help-block form-error text-left"><%= field_errors["id"] %></span>
      <% end %>
      </div>
      <span class="col-sm-1 label label-default additional info-2">?</span>
      <div class='row col-lg-12 settings'>
        <p class="help">The Friendly Name is how you will identify your Camera in the Dashboard. You also need to create an ID for each camera that will have to be Unique to Evercam.</p>
      </div>
    </div>
    <div class='col-lg-4'>
      <div class="media">
        <img id="testimg-add" src="/" class="text-center" width="100%">
      </div>
    </div>
  </div>
</fieldset>

<!-- MAKE & MODEL -->
<fieldset>
<div class='row add-row make-model'>
  <div class='col-md-8'>
    <div class='col-md-5 form-group<%= field_errors["vendor"] ? ' has-error' : '' %>'>
      <%= label_tag('camera-vendor', "Camera Vendor", class: "control-label") %>
      <%= select_tag('camera-vendor', options_from_collection_for_select(vendors, "exid", "name"), prompt: "Select Make", selected: @user[:vendor]) %>
      <% if field_errors["vendor"] %>
        <span class="help-block form-error text-left"><%= field_errors["vendor"] %></span>
      <% end %>
    </div>

    <div class='col-md-5 model form-group<%= field_errors["model"] ? ' has-error' : '' %>'>
      <%= label_tag('camera-model', "Camera Model", class: "control-label") %>
      <% vendors.each do |v| -%>
        <select id="camera-model<%= v.exid -%>" name="camera-model<%= v.exid -%>" class="form-control camera-model hidden">
          <% models(v.id).each_with_index  do |m, index| -%>
            <% if index == 0 %>
              <option selected="selected" value="<%= m.name  -%>"><%= m.name -%></option>
            <% else %>
              <option value="<%= m.name  -%>"><%= m.name -%></option>
            <% end %>
          <% end -%>
        </select>
      <% end %>
      <% if field_errors["model"] %>
        <span class="help-block form-error text-left"><%= field_errors["model"] %></span>
      <% end %>
    </div>

    <span class="col-sm-1 label label-default additional info-2">?</span>
    <div class='col-lg-11 settings row'>
      <p class="help">The Camera Vendor &amp; Model can help retrieve the snapshot of the Camera.</p>
    </div>

  </div>
</div>
</fieldset>



<div class='row'>
  <div class='col-md-12'>
    <div class='col-md-8'>

      <!-- SNAPSHOT PATH -->
      <fieldset>
      <div class="row add-row snap-path">

        <div id="ext-ip" class='col-md-4 form-group<%= field_errors["external_host"] ? ' has-error' : '' %>'>
          <%= label_tag('camera-url', raw("External <strong>IP</strong> (or URL)*"), class: "control-label") %>
          <div class="input-group">
            <span class="input-group-addon">http://</span>
            <%= text_field_tag("camera-url", @user['camera-url'], "placeholder" => "149.5.43.10", "class" => "form-control", "data-validation" => "custom", "data-validation-regexp" => "^[a-zA-Z0-9._/-]{2,100}$", "data-validation-error-msg" => "This doesn't appear to be a valid IP or URL.") %>
            <% if field_errors["external_host"] %>
            <span class="help-block form-error text-left"><%= field_errors["external_host"] %></span>
            <% end %>
          </div>
        </div>

        <div class='col-md-2 form-group<%= field_errors["external_http_port"] ? ' has-error' : '' %>'>
          <%= label_tag('port', raw("HTTP*"), class: "control-label") %>
          <div class="input-group">
            <span class="prepend">:</span>
          <%= text_field_tag("port", @user['port'], "placeholder" => "8001", "class" => "form-control", "data-validation" => "custom", "data-validation-regexp" => "^[0-9]{2,5}$", "data-validation-error-msg" => "The Port should be a #, 2-5 digits.") %>
          <% if field_errors["external_http_port"] %>
          <span class="help-block form-error text-left"><%= field_errors["external_http_port"] %></span>
          <% end %>
          </div>
        </div>

        <div class='col-md-4 form-group<%= field_errors["jpg_url"] ? ' has-error' : '' %>'>
          <%= label_tag('snapshot', "Snapshot URL Ending*", class: "control-label") %>
          <div class="input-group snap-end">
            <span class="prepend">/</span>
          <%= text_field_tag("snapshot", @user['snapshot'], "placeholder" => "snapshot.jpg", "class" => "form-control", "data-validation" => "custom", "data-validation-regexp" => "^(([a-zA-Z]:)|(\\{2}\w+)\$?)(\\(\w[\w].*))+(.jpeg|.JPEG|.gif|.GIF| .png|.PNG)$/", "data-validation-error-msg" => "This doesn't appear to be a valid snapshot URL ending.") %>
          </div>
        </div>

        <span class="col-sm-1 label label-default additional info-2">?</span>
        <div class='col-lg-12 settings row'>
          <p class="help">This is the snapshot path of the camera. It will contain the IP, the External HTTP port and the entire snapshot ending. eg. http://149.5.43.10:8001/snapshot.jpg</p>
        </div>

      </div>
      </fieldset>


      <!-- USERNAME & PASSWORD -->
      <fieldset>
      <div class='row add-row'>
        <div class='col-md-5 form-group<%= field_errors["username"] ? ' has-error' : '' %>'>
          <%= label_tag('camera-username', "Camera Username", class: "control-label") %>
          <%= text_field_tag("camera-username", @user['camera-username'], "class" => "form-control") %>
          <% if field_errors["username"] %>
            <span class="help-block form-error text-left"><%= field_errors["username"] %></span>
          <% end %>
        </div>
        <div class='col-md-5 form-group<%= field_errors["password"] ? ' has-error' : '' %>'>
          <%= label_tag('camera-password', "Camera Password", class: "control-label") %>
          <%= password_field_tag("camera-password", @user['camera-password'], class: "form-control") %>
          <% if field_errors["password"] %>
            <span class="help-block form-error text-left"><%= field_errors["password"] %></span>
          <% end %>
        </div>

        <span class="col-lg-1 label label-default additional info-2">?</span>
        <div class='col-lg-12 settings row'>
          <p class="help">The camera you are trying to connect will already have a Username &amp; Password associated with it. These credentials will have been created by the camera owner.</p>
        </div>
      </div>
      </fieldset>

    </div><!-- col-8 -->

    <div class='col-lg-4'>
      <div class="test-snapshot">
        <div class="vertical-align">
          <span class="glyphicon glyphicon-arrow-right blue"></span>
        </div>
        <a href="#" id="test" class="btn btn-primary ladda-button" role="button" data-style="expand-left"><span class="ladda-label">Test Snapshot</span></a>
        <div id="test-error"></div>
      </div>
    </div>

  </div><!-- col-12 -->

</div><!-- row -->


<fieldset>
  <div class="add-row-bottom">
    <p class="col-lg-8 additional expand"><span class="glyphicon glyphicon-plus"></span>Additional Settings</p>

    <!-- STEP 4  -->
    <div class="col-md-6 settings">

      <div class="row">
        <div class='col-md-6 form-group<%= field_errors["internal_host"] ? ' has-error' : '' %>'>
          <%= label_tag('local-ip', "Local IP", class: "control-label") %>
          <div class="input-group">
          <span class="input-group-addon">http://</span>
          <%= text_field_tag("local-ip", @user['local-ip'], "class" => "form-control", "data-validation" => "custom", "data-validation-regexp" => "^[a-zA-Z0-9._/-]{2,100}$", "data-validation-error-msg" => "This doesn't appear to be a valid IP or URL.", "data-validation-optional" => "true") %>
          <% if field_errors["internal_host"] %>
            <span class="help-block form-error text-left"><%= field_errors["internal_host"] %></span>
          <% end %>
            </div>
        </div>
        <div class='col-md-6 form-group<%= field_errors["internal_http_port"] ? ' has-error' : '' %>'>
          <%= label_tag('local-http', "Local HTTP Port", class: "control-label") %>
          <%= text_field_tag("local-http", @user['local-http'], "class" => "form-control", "data-validation" => "custom", "data-validation-regexp" => "^[0-9]{2,5}$", "data-validation-error-msg" => "The Port should be a 2-5 digit number.", "data-validation-optional" => "true") %>
          <% if field_errors["internal_http_port"] %>
            <span class="help-block form-error text-left"><%= field_errors["internal_http_port"] %></span>
          <% end %>
        </div>
      </div>
      <div class="row">
        <div class='col-md-6 form-group<%= field_errors["external_rtsp_port"] ? ' has-error' : '' %>'>
          <%= label_tag('ext-rtsp-port', raw("External RTSP Port"), class: "control-label") %>
          <%= text_field_tag("ext-rtsp-port", @user['ext-rtsp-port'], "placeholder" => "554", "class" => "form-control", "data-validation" => "custom", "data-validation-regexp" => "^[0-9]{2,5}$", "data-validation-error-msg" => "The Port should be a #, 2-5 digits.", "data-validation-optional" => "true") %>
          <% if field_errors["external_rtsp_port"] %>
            <span class="help-block form-error text-left"><%= field_errors["external_rtsp_port"] %></span>
          <% end %>
        </div>
        <div class='col-md-6 form-group<%= field_errors["internal_rtsp_port"] ? ' has-error' : '' %>'>
          <%= label_tag('local-rtsp', "Local RTSP Port", class: "control-label") %>
          <%= text_field_tag("local-rtsp", @user['local-rtsp'], "class" => "form-control", "data-validation" => "custom", "data-validation-regexp" => "^[0-9]{2,5}$", "data-validation-error-msg" => "The Port should be a 2-5 digit number.", "data-validation-optional" => "true") %>
        <% if field_errors["internal_rtsp_port"] %>
          <span class="help-block form-error text-left"><%= field_errors["internal_rtsp_port"] %></span>
        <% end %>
        </div>
      </div>

    </div><!-- Step 4 -->
  </div>
</fieldset>

<!-- FINISH & ADD -->
<fieldset>
  <div class='row add-row'>
    <div class='col-md-12'>
      <div class="form-group">
        <label class="control-label" for="add-button"></label>
        <button id="add-button" name="add-button" class="btn btn-primary">Finish &amp; Add</button>
      </div>
    </div>
  </div>
</fieldset>

<!-- SUPPORT -->
<div class="row add-row add-footer">
  <div class='col-lg-10'>
    <div class='col-lg-12'>
    <h5>Still Can't See Your Camera?</h5>
    <ul class="list-inline">
      <li><a href="http://www.evercam.io/develop/help" target="_blank">Help Pages</a></li>
      <!--<li><a href="#" target="_blank">Support</a></li>-->
    </ul>
    <p>If you don't the details of a camera yourself and would like to see how this process works, you can use the placeholder information and the info given in the examples in the help ? icons and it will work!</p>
  </div>
  </div>
</div>

<% end %>
<!-- FORM END. -->

</section>
<!--main content end-->
</div>
</section>
</div>
</div> <!--boxed page end-->

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-form-validator/2.1.47/jquery.form-validator.min.js"></script>
<script>
  function validate_hostname(str) {
    var ValidIpAddressRegex = /^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$/;
    var ValidHostnameRegex = /^(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\-]*[A-Za-z0-9])$/;
    return ValidIpAddressRegex.test(str) || ValidHostnameRegex.test(str);
  }

  $(document).ready(function () {
    $('#test').click(function (e) {
      var intRegex = /^\d+$/,
          port = $('#port').val(),
          ext_url = $('#camera-url').val();
      e.preventDefault();
      // Validate port
      if(port !== '' && (!intRegex.test(port) || port > 65535)) {
        $('#test-error').text('Port value is incorrect');
        return;
      } else if (port !== '') {
        port = ':' + port;
      }
      // Validate host
      if (ext_url === '' || !validate_hostname(ext_url)) {
        $('#test-error').text('External URL is incorrect');
        return;
      } else if (ext_url.indexOf('192.168') == 0 || ext_url.indexOf('127.0.0') == 0 || ext_url.indexOf('10.') == 0) {
        $('#test-error').text('This is local IP. Please use external IP.');
        return;
      }
      var params = ['external_url=http://' + ext_url + port, 'jpg_url=' + $('#snapshot').val(),
            'cam_username=' + $('#camera-username').val(), 'cam_password=' + $('#camera-password').val()];
      var l = Ladda.create(this);
      l.start();
      var progress = 0;
      var interval = setInterval(function () {
        progress = Math.min(progress + 0.025, 1);
        l.setProgress(progress);

        if (progress === 1) {
          l.stop();
          clearInterval(interval);
        }
      }, 200);

      $.getJSON('<%= EVERCAM_API %>cameras/test.json?' + params.join('&'))
          .done(function (resp) {
            console.log('success');
            $('#test-error').text('Snapshot successfully retrieved');
            $('#testimg-add').attr('src', resp.data);
          })
          .fail(function (resp) {
            $('#test-error').text(resp.responseJSON.message);
            console.log('error');
          })
          .always(function () {
            l.stop();
            clearInterval(interval);
          });
    });

    // TOGGLE ADD. SETTINGS
    $(".settings").hide();
    //toggle the componenet with class msg_body
    $(".additional").click(function () {
      $(this).next(".settings").slideToggle(500);
    });

    Notification.init(".bb-alert");
    <% if flash[:message] %>
    Notification.show('<%= flash[:message][0] %>');
    <% end %>

    var previous;
    $('#camera-vendor').one('focus', function () {
      previous = this.value;
    }).on('change', function () {
      $('#camera-model' + previous).addClass('hidden');
      $('#camera-model' + this.value).removeClass('hidden');
      previous = this.value;
    });

    $.validate();
  });
</script>

