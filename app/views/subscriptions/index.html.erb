<div class="bb-alert alert alert-info" style="display:none;">
  <span></span>
</div>
<div class="subscriptions page-content-wrapper">
  <div class="page-content">
    <% render partial: "users/section_header", locals: { section_header_title: "Evercam: Billing" } %>

    <%= render 'cart' %>

    <div class="col-md-12 margin-top-20">
      <h3>Cards</h3>
      <div class="card">
        <%= render partial: 'shared/stripe' %>
        <% if has_credit_cards? %>
          <% @credit_cards.each do |card| -%>
            <p><i class="fa fa-credit-card"></i>
              <strong> <%= card.brand -%></strong> exp. <strong><%= card.exp_month -%>&#47;<%= card.exp_year %></strong> ending in <strong>..<%= card.last4 -%></strong>
              <i><%= default_card?(card.id) ? ' - default card' : (link_to '', stripe_customer_path({:card_id => card.id, :default_source => true}), method: :put) %></i></p>
          <% end -%>
          <a class="" data-toggle="modal" data-target="#myModal">
            Manage Cards
          </a>
          <%= render 'manage_cards' %>
        <% else %>
          <p>No card added</p>
          <%= render 'add_card' %>
        <% end %>
      </div>
    </div>

    <div class="col-md-12">
      <h3>Plans</h3>
      <div class="card">
        <% unless !@next_charge %>
          <p>Your next charge of
            <strong><%= cents_to_currency @next_charge[:total] %></strong>
            is on <%= Time.at(@next_charge[:date]).strftime("%d %b %Y") %>.</p>
        <% end %>
        <%= render "plans_comparison" %>
      </div>
    </div>

    <div class="col-md-12">
      <h3>Add-ons</h3>
      <div class="card">
        <%= render 'current_add_ons' %>
      </div>
    </div>

    <div class="col-md-7">
      <h3>Payment History</h3>
      <%= render 'billing_history' %>
    </div>

    <div class="col-md-5">
      <h3>Invoices</h3>
      <%= render 'invoices' %>
    </div>

  </div>
</div>

<script>
  window.initializeSubscription();
  <% if flash[:message] %>
  Notification.show('<%= flash[:message] %>');
  <% end %>
  (function() {
    [].slice.call( document.querySelectorAll( '.checkout' ) ).forEach( function( el ) {
      var openCtrl = el.querySelector( '.checkout__button' ),
          closeCtrls = el.querySelectorAll( '.checkout__cancel' );

      openCtrl.addEventListener( 'click', function(ev) {
        ev.preventDefault();
        classie.add( el, 'checkout--active' );
      } );

      [].slice.call( closeCtrls ).forEach( function( ctrl ) {
        ctrl.addEventListener( 'click', function() {
          classie.remove( el, 'checkout--active' );
        } );
      } );
    } );
  })();
</script>
