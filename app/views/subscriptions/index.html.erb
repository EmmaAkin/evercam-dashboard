<div class="bb-alert alert alert-info" style="display:none;">
  <span></span>
</div>
<div class="subscriptions page-content-wrapper">
  <div class="page-content">
    <%# render partial: "users/section_header", locals: { section_header_title: "Billing" } %>

      <%= render 'navigation' %>
      <div class="col-md-12">
        <h3>Cards</h3>
        <div class="card">
          <%= render partial: 'shared/stripe' %>

          <% if has_credit_cards? %>
            <% @credit_cards.each do |card| -%>
            <p><i class="fa fa-credit-card"></i>
              <strong> <%= card.brand -%></strong> exp. <strong><%= card.exp_month -%>&#47;<%= card.exp_year %></strong> ending in <strong>..<%= card.last4 -%></strong>
              <i><%= default_card?(card.id) ? ' - default card' : (link_to '', stripe_customer_path({:card_id => card.id, :default_source => true}), method: :put) %></i></p>
            <% end -%>
            <a class="" data-toggle="modal" data-target="#myModal">
              Manage Cards
            </a>
            <%= render 'manage_cards' %>
          <% else %>
            <p>You have no card added</p>
            <%= render 'add_card' %>
          <% end %>
        </div>
      </div>

      <div class="col-md-4">
        <h3>Plan</h3>
        <div class="card">
          <p>Your on the <strong><%= render 'current_subscription' %></strong> plan</p>
          <%= link_to 'Change your Plan', plans_path(current_user.username) %>
        </div>
      </div>

      <div class="col-md-8">
        <h3>Add-ons</h3>
        <div class="card">
          <% unless @add_ons.present? %>
            <p>You have no add-ons</p>
          <% end %>
          <%= render 'current_add_ons' %>
        </div>
      </div>
    <div class="col-md-12">
      <h3>Payment History</h3>
      <div class="card">
        <% if !@billing_history %>
          <p>You have no billing history.</p>
        <% else %>
          <table style="width:100%;" class="table table-full-width">
            <tr>
              <th class="col-md-2">Date</th>
              <th class="col-md-3">Description</th>
              <th class="col-md-2">Amount</th>
              <th class="col-md-2">Action</th>
            </tr>
            <% @billing_history.first(5).each do |item| %>
              <tr>
                <td>
                  <span data-toggle="tooltip" data-placement="top" title="<%= Time.at(item[:created]).strftime("%I:%M%P") %>">
                    <%= Time.at(item[:created]).strftime("%d %b %Y") %>
                  </span>
                </td>
                <td><%= item[:description].blank? ? retrieve_customer_plan(item[:invoice]) : item[:description] %></td>
                <td><%= cents_to_currency item[:amount] %></td>
                <td><%= item[:paid] ? "Payment" : "Payment Pending" %></td>
              </tr>
            <% end %>
          </table>
          <%= link_to 'View all payments', billing_history_path(current_user.username) %>
        <% end %>
      </div>
      <h3>Invoices</h3>
      <div class="invoices card">
        <% if !@invoices %>
          <p>You have no invoices.</p>
        <% else %>
          <table style="width:100%;" class="table table-full-width">
            <tr>
              <th class="col-md-2">Date</th>
              <th class="col-md-2">Total</th>
              <th class="col-md-2">Status</th>
              <th class="col-md-2">Action</th>
            </tr>
            <% @invoices.each do |invoice| %>
              <tr>
                <td><%= link_to Time.at(invoice[:date]).strftime("%d %B %Y"), invoice_show_path(current_user.username, invoice[:id])%></td>
                <td><%= cents_to_currency(invoice[:total]) %></td>
                <td>
                  <% if invoice[:paid] %>
                    <span class="green">Paid</span>
                  <% else %>
                    <span class='green'>Pending</span>
                  <% end %>
                </td>
                <td>
                  <span class="download-pdf"><a>PDF</a><i class="fa fa-file-pdf-o"></i></span>
                  <span class="send-email"><%= link_to "Email", send_invoic_email_path(current_user.username, invoice[:id])%><i class="fa fa-send-o"></i></span>
                </td>
              </tr>
            <% end %>
          </table>
          <%= link_to 'View all invoices', invoices_path(current_user.username) %>
        <% end %>
      </div>

    </div>

  </div>
</div>

<script>
  window.initializeSubscription();
  <% if flash[:message] %>
  Notification.show('<%= flash[:message] %>');
  <% end %>
</script>
