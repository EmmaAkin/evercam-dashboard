<head lang="en">
   <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
</head>
<body style="margin: 0px;">
<% if @unathorized %>
  <h1>Unauthorized</h1>
You are not allowed to view this camera
<% elsif @not_exist %>
  <p style="font-family: helvetica, arial">We are unable to fetch a live feed from this camera.<p>
<% else %>

<div>
  <img style="width: 100%" src="<%= EVERCAM_API %>cameras/<%= params[:camera] %>/live/snapshot?api_id=<%= current_user.api_id %>&api_key=<%= current_user.api_key %>" />
</div>

<script>
  var refresh = 1000*<%= params[:refresh] %>,
    url = $('img').attr('src'),
    container = $('div'),
    imgStyle = "width: 100%;";
  function updateImage() {
    if (refresh > 0) {
      window.ec_watcher = setTimeout(updateImage, refresh);
    }
    jQuery("<img style='" + imgStyle + "'/>").attr('src', url + '&' + new Date().getTime())
      .load(function() {
        if (!this.complete || this.naturalWidth === undefined || this.naturalWidth === 0) {
          console.log('broken image!');
        } else {
          container.empty().append(jQuery(this))
          console.log('updated');
        }
      });
  }

  function handleVisibilityChange() {
    if (document.hidden) {
      clearTimeout(window.ec_watcher);
      console.log('stop');
    } else  {
      updateImage();
      console.log('start');
    }
  }

  updateImage();
  window.ec_vis_handler = handleVisibilityChange;
  document.addEventListener("visibilitychange", handleVisibilityChange, false);

</script>
<% end %>
</body>
