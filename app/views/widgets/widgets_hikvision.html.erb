<%= content_for(:title, "Evercam: Hikvision Playback Widget") %>

<div id="hikvision-widget" class="page-container">
  <!-- BEGIN SIDEBAR -->
  <%= render :partial => "shared/sidebar" %>
  <!-- END SIDEBAR -->
  <div class="page-content-wrapper">
    <div class="page-content">

      <!-- Slidey sidey -->
      <div class="cbp-spmenu-push">
        <nav class="cbp-spmenu cbp-spmenu-open cbp-spmenu-vertical cbp-spmenu-left" id="cbp-spmenu-s1">
          <h3>Menu</h3>
          <ul>
            <li>
              <a href="/dev">API Docs</a>
            </li>

            <div class="dev-menu-title">
              Widgets
            </div>

            <li class="widgets-menu">
              <a href="/widgets-new">Live View Widget</a>
            </li>

            <li class="widgets-menu">
              <a class="active" href="/widgets-hikvision">Hikvision Widget</a>
            </li>
          </ul>
        </nav>
      </div>

      <!--main content start-->

      <div class="portlet light bg-inverse">
        <div class="portlet-title">
          <div class="caption">
            <i class="icon-play"></i>Create a Hikvision Playback Widget
          </div>
        </div>

        <div class="portlet-body">
          <div class="row">
            <div id="hikvision-widget" class="widget-config">
              <% if @cameras.empty? %>
                <div class="col-md-5">
                  <p class="note note-info">No public cameras found. Only public cameras can be used to make a widget. You can make a camera public from the sharing tab of camera or add a public camera from the list of public cameras.</p>
                </div>
              <% else %>
                <div class="col-md-5">
                  <form id="widget-new" role="form" method="post" class="center-block">
                    <div class="widget-input form-group">
                      <div class="my-row">
                        <label class="col-md-5 control-label" for="widget-camera">Select Camera</label>
                      </div>
                      <div class="input-group col-md-7">
                        <select id="widget-camera" name="widget-camera" class="form-control is-required">
                          <% @cameras.each do |camera| %>
                            <% has_edit_right = camera["rights"].split(",").include?("edit") %>
                            <% if camera['vendor_name'] == 'Hikvision Digital Technology' && has_edit_right %>
                              <option value="<%= camera['id'] %>">
                                <%= camera['name'] %> <% unless camera['is_online'] %>(Offline)<% end %> <% unless camera['is_public'] %>(Private)<% end %>
                              </option>
                            <% end %>
                          <% end %>
                        </select>
                      </div>
                    </div>

                    <div class="form-group widget-input margin-top-10">
                      <div class="my-row">
                        <label class="col-md-5 control-label" for="widget-datetime">Date</label>
                      </div>
                      <div class="input-group col-md-7">
                        <input type="text" class="form-control" id="widget-datetime" readonly name="widget-datetime">
                      </div>
                    </div>

                    <div class="form-group widget-input margin-top-10">
                      <div class="my-row">
                        <label class="col-md-5 control-label" for="widget-datetime">Time</label>
                      </div>
                      <div class="input-group col-md-7">
                        <div class="col-md-4 dropdown-hours"><select id="widget-hour" name="widget-hour" class="time-dropdown form-control is-required"></select></div>
                        <div class="col-md-4 dropdown-minutes"><select id="widget-minutes" name="widget-hour" class="time-dropdown form-control is-required"></select></div>
                        <div class="col-md-4"><select id="widget-seconds" name="widget-hour" class="time-dropdown form-control is-required"></select></div>
                      </div>
                    </div>

                    <div class="form-group widget-input margin-top-10">
                      <div class="my-row">
                        <label class="col-md-5 control-label" for="widget-authenticate">Pre-Authenticate<span style="visibility: hidden;" class="true switch grey">*</span></label>
                      </div>
                      <div class="input-group col-md-7">
                        <select id="widget-authenticate" name="widget-authenticate" class="form-control is-required">
                          <option class="" value="false">No</option>
                          <option class="" value="true">Yes</option>
                        </select>
                      </div>
                    </div>

                    <div class="true switch help-block margin-top-10" style="visibility: hidden;">
                      * Warning. Choosing 'Yes' will include your API ID and Key. This should only be done on private sites. We recommend you do not choose this option for public sites.
                    </div>
                  </form>

                </div>
                <div class="col-md-7">
                  <div class="row widget-code">
                    <div class="col-md-12">
                      <h5>Embed this code on your webpage:</h5>
                      <textarea id="code" class="pretty-code col-md-12" type="text" readonly>
                      </textarea>
                    </div>
                    <div class="col-md-12 margin-top-30">
                      <input id="btn-load-widget" name="btn-load-widget" type="button" class="btn blue" value="Load Widget">
                    </div>
                  </div>

                </div>

                <div class="clear-f"></div>

                <div class="col-md-12">
                  <div class="line-break"></div>
                  <div evercam="localstorage" class="placeholder"></div>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>

      <!--main content end-->
    </div>
  </div>
</div>
<!-- <div evercam="localstorage"></div> -->
<script type="text/javascript" src="https://s3.amazonaws.com/cdn.evercam.io/js/localstorage/0.0.1/hikvision.local.storage.mini.js"></script>
<script type="text/javascript">
  $(document).ready(function () {
    $('#widget-datetime').datetimepicker({
      timepicker: false,
      closeOnDateSelect: 0,
      format: 'd-m-Y'
    });
    initLocalStorage();
    $("#btn-load-widget").on("click", initLocalStorage);
    $("#widget-authenticate").on("change", showNote);
    $("#code").on("click", function(){
      this.select();
    });
    for(var i=0;i<60;i++){
      var option = '<option value="'+FormatNumTo2(i)+'">'+FormatNumTo2(i)+'</option>';
      if(i < 24)
        $("#widget-hour").append(option);
      $("#widget-minutes").append(option);
      $("#widget-seconds").append(option);
    }
  });

  function FormatNumTo2 (n) {
    if (n < 10)
      return "0"+n;
    else
      return n;
  }

  function initLocalStorage() {
    var url = window.location.origin;
    var camera = $("#widget-camera").val();
    var camera_name = $('#widget-camera option:selected').text()
    var pre_auth = $('#widget-authenticate').val();
    var is_private = camera_name.indexOf('(Private)') == -1 ? 'false' : 'true';
    var api_credentials = '';
    var date_time = '';
    var stringDateTime = '';

    if($('#widget-datetime').val()){
      stringDateTime = $('#widget-datetime').val()+"T"+$('#widget-hour').val()+":"+$('#widget-minutes').val()+":"+$('#widget-seconds').val()+"Z";
      date_time = "&amp;date_time&#61;" + stringDateTime;
    }

    if(pre_auth == 'true') {
      api_credentials = "&amp;api_id&#61;<%= current_user.api_id -%>&amp;api_key&#61;<%= current_user.api_key -%>";
    }

    var embedCode = '&lt;div evercam&#61;"localstorage"&gt;&lt;&#47;div&gt;'+
        '&lt;script type&#61;"text/javascript" src&#61;"' + url + '&#47;hikvision.local.storage.js?camera&#61;' + camera+'&amp;private&#61;'+is_private + api_credentials + date_time + '"&gt;&lt;&#47;script&gt;';
    $('#code').html(embedCode);

    $(".placeholder").empty();
    LocalStorage.options.cameraId = camera;
    LocalStorage.options.api_id = '<%= current_user.api_id -%>';
    LocalStorage.options.api_key = '<%= current_user.api_key -%>';
    LocalStorage.options.date_time = stringDateTime;
    LocalStorage.Load();
  }

  function showNote(){
    if($(this).val()){
      var preElements = document.getElementsByClassName('switch');
      for(var i=0; i < preElements.length; i++){
        //if the class contains the selected value, then show it, else hide it
        preElements[i].style.visibility = preElements[i].classList.contains($(this).val())?'visible':'hidden';
      }
    }
  }
</script>
